#include <LiquidCrystal.h>
#include<string>
#define BUTTON1 BT1
#define BUTTON2 BT2
#define BUTTON3 BT3
#define BUTTON4 BT4

LiquidCrystal lcd(8, 9, 4, 5, 6, 7);
char KeyValue[]={'1','2','3','A','4','5','6','B','7','8','9','C','*','0','#','D'};
byte Row=0, Col=0;

int speakerPin = D3;
// 依照簡譜的順序，填入代表的音符，空白代表休止符
char notes[] = "ccggaagffeeddc ";
// 決定每個音階的拍子，注意這邊用 unsigned long 所以拍子只能是正整數
unsigned long beats[] = {1,1,1,1,1,1,2,1,1,1,1,1,1,2,4};
// 利用 sizeof()，算出總共要多少音符
int length = sizeof(notes);
// 決定一拍多長，這邊一拍 300 ms
int tempo = 300;
String names[] = { "Do", "Re", "Mi", "Fa", "So", "La", "Si"};
//========高、中、低音輸出=================
int high[] = { 1046, 1175, 1318, 1397, 1568, 1760, 1976, 2092 };
int middle[] = { 523, 587, 659, 698, 784, 880, 988, 1046 };
int low[] = { 261, 294, 330, 349, 392, 440, 494, 523 };
//=========================================
int tones[3][7] = {
                  {1046, 1175, 1318, 1397, 1568, 1760, 1976},
                  {523, 587, 659, 698, 784, 880, 988},
                  {261, 294, 330, 349, 392, 440, 494} 
                 };
int toneflag = -1;  //0=high, 1=middle, 2=low

void b1()
{
  lcd.setCursor(0,0);
  lcd.print("                ");
  lcd.setCursor(0,0);
  lcd.print(names[0]);
  if(toneflag == 0){
    
    lcd.print("          High");
  }else if(toneflag == 1){
    
    lcd.print("        Middle");
  }
  else if(toneflag == 2){
    
    lcd.print("           Low");
  }
  lcd.noCursor();
  tone(speakerPin, tones[toneflag][0], tempo);
  delay(tempo);
  noTone(speakerPin);
}
void b2()
{
  lcd.setCursor(0,0);
  lcd.print("                ");
  lcd.setCursor(0,0);
  lcd.print(names[1]);
  lcd.noCursor();
  tone(speakerPin, tones[toneflag][1], tempo);
  delay(tempo);
  noTone(speakerPin);
}
void b3()
{
  lcd.setCursor(0,0);
  lcd.print("                ");
  lcd.setCursor(0,0);
  lcd.print(names[2]);
  lcd.noCursor();
  tone(speakerPin, tones[toneflag][2], tempo);
  delay(tempo);
  noTone(speakerPin);
}
void b4()
{
  lcd.setCursor(0,0);
  lcd.print("                ");
  lcd.setCursor(0,0);
  lcd.print(names[3]);
  lcd.noCursor();
  tone(speakerPin, tones[toneflag][3], tempo);
  delay(tempo);
  noTone(speakerPin);
}
void b5()
{
  lcd.setCursor(0,0);
  lcd.print("                ");
  lcd.setCursor(0,0);
  lcd.print(names[4]);
  lcd.noCursor();
  tone(speakerPin, tones[toneflag][4], tempo);
  delay(tempo);
  noTone(speakerPin);
}
void b6()
{
  lcd.setCursor(0,0);
  lcd.print("                ");
  lcd.setCursor(0,0);
  lcd.print(names[5]);
  lcd.noCursor();
  tone(speakerPin, tones[toneflag][5], tempo);
  delay(tempo);
  noTone(speakerPin);
}
void b7()
{
  lcd.setCursor(0,0);
  lcd.print("                ");
  lcd.setCursor(0,0);
  lcd.print(names[6]);
  lcd.noCursor();
  tone(speakerPin, tones[toneflag][6], tempo);
  delay(tempo);
  noTone(speakerPin);
}
void bA()
{
  toneflag = 0;
  lcd.setCursor(0,0);
  lcd.print("                ");
  lcd.setCursor(0,0);
  lcd.print("            High");
  lcd.noCursor();
}
void bB()
{
  toneflag = 1;
  lcd.setCursor(0,0);
  lcd.print("                ");
  lcd.setCursor(0,0);
  lcd.print("          Middle");
  lcd.noCursor();
}
void bC()
{
  toneflag = 2;
  lcd.setCursor(0,0);
  lcd.print("                ");
  lcd.setCursor(0,0);
  lcd.print("             Low");
  lcd.noCursor();
}
void setup() {
  pinMode(speakerPin, OUTPUT);

  pinMode(10, INPUT); //R1: S1,S2,S3,S4 (1,2,3,A)                                   
  pinMode(11, INPUT_PULLUP); //R2: S5,S6,S7,S8 (4,5,6,B)
  pinMode(12, INPUT_PULLUP); //R3: S9, S10, S11,S12 (7,8,9,C)
  pinMode(13, INPUT_PULLUP); //R4: (*,0,#,D)
  pinMode(A0, OUTPUT); //A1, C1: S1,S5,S9 (1,4,7,*)
  pinMode(A1, OUTPUT); //A2, C2: S2,S6,S10 (2,5,8,0)
  pinMode(A2, OUTPUT); //A3, C3: S3,S7,S11 (3,6,9,#)
  pinMode(A3, OUTPUT); //A4, C4: S4,S8,S12 (*,0, #,D)
  //Pin left to right :R1 R2 R3 R4 C1 C2 C3 C4

  digitalWrite(A0,HIGH);
  digitalWrite(A1,HIGH);
  digitalWrite(A2,HIGH);
  digitalWrite(A3,HIGH);

  // start the library
  lcd.begin(16, 2);  
  lcd.clear();            
  lcd.setCursor(0,0);   //顯示cursor在左上角
  lcd.cursor();

}

void loop() 
{
  static int keypressedcount=0;
  byte keyindex=0;
  
  if(keyscan()==true) 
  {
    keyindex=(Row-1)*4+Col;
    delay(5);
    if ((keyscan()==true) && (keyindex=(Row-1)*4+Col))
    {
        char pressKey = KeyValue[keyindex - 1];
        digitalWrite(A0,LOW);
        digitalWrite(A1,LOW);
        digitalWrite(A2,LOW);
        digitalWrite(A3,LOW);
        delayMicroseconds(100);
        while( (digitalRead(10)==LOW) || (digitalRead(11)==LOW) || 
               (digitalRead(12)==LOW) || (digitalRead(13)==LOW))
          ; 
        
        if(pressKey == '1') b1();
        if(pressKey == '2') b2();
        if(pressKey == '3') b3();
        if(pressKey == '4') b4();
        if(pressKey == '5') b5();
        if(pressKey == '6') b6();
        if(pressKey == '7') b7();
        if(pressKey == 'A') bA();
        if(pressKey == 'B') bB();
        if(pressKey == 'C') bC();
    }
  } 
}

bool keyscan( )
{
  Row=0;Col=0;
  bool keypressed = false;
  //scan col1
  digitalWrite(A0, LOW);
  digitalWrite(A1, HIGH);
  digitalWrite(A2, HIGH);
  digitalWrite(A3, HIGH);
  delayMicroseconds(100);
  //Read keys in row.1
  if(digitalRead(10)==LOW)
  {
      digitalWrite(A0, HIGH);
      Col=1;Row=1;
      keypressed = true;
      return(keypressed);
  }
  //Read keys in row.2
  if(digitalRead(11)==LOW)
  {
      digitalWrite(A0, HIGH);
      Col=1;Row=2;
      keypressed = true;
      return(keypressed);
  }
  //Read keys in row.3
  if(digitalRead(12)==LOW)
  {
      digitalWrite(A0, HIGH);
      Col=1;Row=3;
      keypressed = true;
      return(keypressed);
  }
  //Read keys in row.4
  if(digitalRead(13)==LOW)
  {
       digitalWrite(A0, HIGH);
      Col=1;Row=4;
      keypressed = true;
      return(keypressed);
  }
  //scan col 2  
  digitalWrite(A0, HIGH);
  digitalWrite(A1, LOW);
  digitalWrite(A2, HIGH);
  digitalWrite(A3, HIGH);
  delayMicroseconds(100);
  //Read keys in row.1
  if(digitalRead(10)==LOW)
  {
      digitalWrite(A1, HIGH);
      Col=2;Row=1;
      keypressed = true;
      return(keypressed);
  }
    //Read keys in row.2
  if(digitalRead(11)==LOW)
  {
      digitalWrite(A1, HIGH);
      Col=2;Row=2;
      keypressed = true;
      return(keypressed);
  }
  //Read keys in row.3
  if(digitalRead(12)==LOW)
  {
      digitalWrite(A1, HIGH);
      Col=2;Row=3;
      keypressed = true;
      return(keypressed);
  }
  //Read keys in row.4
  if(digitalRead(13)==LOW)
  {
      digitalWrite(A1, HIGH);
      Col=2;Row=4;
      keypressed = true;
      return(keypressed);
  }

  //scan col 3  
  digitalWrite(A0, HIGH);
  digitalWrite(A1, HIGH);
  digitalWrite(A2, LOW);
  digitalWrite(A3, HIGH);
  delayMicroseconds(100);
  //Read keys in row.1
  if(digitalRead(10)==LOW)
  {
      digitalWrite(A2, HIGH);
      Col=3;Row=1;
      keypressed = true;
      return(keypressed);
  }
  //Read keys in row.2
  if(digitalRead(11)==LOW)
  {
      digitalWrite(A2, HIGH);
      Col=3;Row=2;
      keypressed = true;
      return(keypressed);
  }  
  //Read keys in row.3
  if(digitalRead(12)==LOW)
  {
      digitalWrite(A2, HIGH);
      Col=3;Row=3;
      keypressed = true;
      return(keypressed);
  }
  //Read keys in row.4
  if(digitalRead(13)==LOW)
  {
      digitalWrite(A2, HIGH);
      Col=3;Row=4;
      keypressed = true;
      return(keypressed);
  }
  
  //scan col 4  
  digitalWrite(A0, HIGH);
  digitalWrite(A1, HIGH);
  digitalWrite(A2, HIGH);
  digitalWrite(A3, LOW);
  delayMicroseconds(100);
  //Read keys in row.1
  if(digitalRead(10)==LOW)
  {
      digitalWrite(A3, HIGH);
      Col=4;Row=1;
      keypressed = true;
      return(keypressed);
  }
    //Read keys in row.2
  if(digitalRead(11)==LOW)
  {
      digitalWrite(A3, HIGH);
      Col=4;Row=2;
      keypressed = true;
      return(keypressed);
  }
  //Read keys in row.3
  if(digitalRead(12)==LOW)
  {
      digitalWrite(A3, HIGH);
      Col=4;Row=3;
      keypressed = true;
      return(keypressed);
  }
  //Read keys in row.4
  if(digitalRead(13)==LOW)
  {
      digitalWrite(A3, HIGH);
      Col=4;Row=4;
      keypressed = true;
      return(keypressed);
  }
  return(false);
}
